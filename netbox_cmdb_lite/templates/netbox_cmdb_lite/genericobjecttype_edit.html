<form method="post" onsubmit="updateAttributesField();">
    {% csrf_token %}
    <div class="form-group">
        <label for="id_name">Name</label>
        <input type="text" id="id_name" name="name" class="form-control" value="{{ form.name.value }}">
    </div>

    <div class="form-group">
        <label>Object Fields</label>
        <p>Add one or more fields, including their type and optional settings.</p>
        <div id="attributes-container">
            <!-- Dynamic attributes will be injected here -->
        </div>
        <button type="button" class="btn btn-secondary" onclick="addAttribute()">Add Field</button>
    </div>

    <button type="submit" class="btn btn-primary">Save</button>
</form>

<script>
    const container = document.getElementById("attributes-container");
    const attributesField = document.getElementById("id_attributes");

    function addAttribute(name = "", type = "string", options = "", reference = "") {
        const div = document.createElement("div");
        div.className = "form-row mb-2";
        div.innerHTML = `
            <div class="col">
                <input type="text" class="form-control" placeholder="Field Name" value="${name}" oninput="updateAttributesField()" />
            </div>
            <div class="col">
                <select class="form-control" onchange="updateAttributesField()">
                    <option value="string" ${type === "string" ? "selected" : ""}>String</option>
                    <option value="integer" ${type === "integer" ? "selected" : ""}>Integer</option>
                    <option value="boolean" ${type === "boolean" ? "selected" : ""}>Boolean</option>
                    <option value="multi-choice" ${type === "multi-choice" ? "selected" : ""}>Multi-Choice</option>
                    <option value="foreign-key" ${type === "foreign-key" ? "selected" : ""}>Foreign Key</option>
                </select>
            </div>
            <div class="col">
                <input type="text" class="form-control type-options" placeholder="Options (comma-separated)" value="${options}" oninput="updateAttributesField()" ${type !== "multi-choice" ? "style='display: none;'" : ""} />
            </div>
            <div class="col">
                <input type="text" class="form-control type-reference" placeholder="Reference Model" value="${reference}" oninput="updateAttributesField()" ${type !== "foreign-key" ? "style='display: none;'" : ""} />
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-danger" onclick="removeAttribute(this)">Remove</button>
            </div>
        `;
        container.appendChild(div);
        updateAttributesField();
    }

    function removeAttribute(button) {
        button.parentElement.parentElement.remove();
        updateAttributesField();
    }

    function updateAttributesField() {
        const attributes = [];
        container.querySelectorAll(".form-row").forEach(row => {
            const name = row.children[0].children[0].value.trim();
            const type = row.children[1].children[0].value;
            const optionsInput = row.querySelector(".type-options");
            const options = optionsInput && optionsInput.style.display !== "none" ? optionsInput.value.split(",").map(opt => opt.trim()).filter(opt => opt) : [];
            const referenceInput = row.querySelector(".type-reference");
            const reference = referenceInput && referenceInput.style.display !== "none" ? referenceInput.value.trim() : "";

            if (name) {
                const attribute = { name, type };
                if (type === "multi-choice") attribute.options = options;
                if (type === "foreign-key") attribute.reference = reference;
                attributes.push(attribute);
            }
        });
        attributesField.value = JSON.stringify(attributes); // Save to hidden input field
    }

    // Initialize existing attributes
    const initialAttributes = JSON.parse(attributesField.value || "[]");
    initialAttributes.forEach(attr => addAttribute(attr.name, attr.type, attr.options || "", attr.reference || ""));
</script>
